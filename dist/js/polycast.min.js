!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Polycast=e():t.Polycast=e()}(this,function(){return function(t){function e(s){if(n[s])return n[s].exports;var i=n[s]={exports:{},id:s,loaded:!1};return t[s].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e){!function(){this.Polycast=function(){this.options={},this.channels={},this.timeout=null,this.connected=!1;var t={url:null,polling:5,token:null};if(arguments[0]&&"object"==typeof arguments[0])this.options=this.extend(t,arguments[0]);else{if(!arguments[0]||"string"!=typeof arguments[0])throw"Polycast url must be defined!";if(arguments[1]&&"object"==typeof arguments[1]){var e=this.extend({url:arguments[0]},arguments[1]);this.options=this.extend(t,e)}else this.options=this.extend(t,{url:arguments[0]})}this.init()},this.Polycast.prototype={init:function(){var t=this,e=this.serialize({polling:this.options.polling,_token:this.options.token}),n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return n.open("POST",this.options.url+"/connect"),n.onreadystatechange=function(){n.readyState>3&&200===n.status&&(response=JSON.parse(n.responseText),"success"==response.status&&(t.setTime(response.time),t.setTimeout(),console.log("Polycast connection established!")))},n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(e),this},extend:function(t,e){var n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},setTime:function(t){this.options.time=t},setTimeout:function(){var t=this;this.timeout=setTimeout(function(){t.fetch()},1e3*this.options.polling)},fetch:function(){this.request()},request:function(){var t=this,e={};for(var n in this.channels)if(this.channels.hasOwnProperty(n)){void 0===e[n]&&(e[n]=[]);for(var s=0;s<this.channels[n].length;s++){var i=this.channels[n][s],o=i.events;for(var r in o)e[n].push(r)}}var a={time:this.options.time,channels:e,_token:this.options.token},h=this.serialize(a),u=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return u.open("POST",this.options.url+"/receive"),u.onreadystatechange=function(){u.readyState>3&&200===u.status&&t.parseResponse(u.responseText)},u.setRequestHeader("X-Requested-With","XMLHttpRequest"),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),u.send(h),u},serialize:function(t,e){var n=[];for(var s in t)if(t.hasOwnProperty(s)){var i=e?e+"["+s+"]":s,o=t[s];n.push("object"==typeof o?this.serialize(o,i):encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")},parseResponse:function(t){if(t=JSON.parse(t),"success"==t.status){this.setTime(t.time);for(var e in t.payloads)if(t.payloads.hasOwnProperty(e))for(i=0;i<t.payloads[e].channels.length;++i){var n=t.payloads[e].channels[i];for(index=0;index<this.channels[n].length;++index)this.channels[n][index].fire(t.payloads[e].event,t.payloads[e].payload)}this.setTimeout()}},subscribe:function(t){var e=new PolycastChannel({channel:t});return void 0===this.channels[t]&&(this.channels[t]=[]),this.channels[t].push(e),e}},this.PolycastChannel=function(){this.options={},this.events={};var t={channel:null};if(!arguments[0]||"object"!=typeof arguments[0])throw"Polycast channel options must be defined!";this.options=this.extend(t,arguments[0])},this.PolycastChannel.prototype={init:function(){return this},extend:function(t,e){var n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},on:function(t,e){return void 0===this.events[t]&&(this.events[t]=[]),this.events[t].push(e),this},fire:function(t,e){for(var n in this.events)if(this.events.hasOwnProperty(n)&&n==t){var s=this.events[n];s[0](e)}}},this.Polycast.version="1.0.0",this.PolycastChannel.version="1.0.0",t.exports=this.Polycast}()}])});